################################################################################
# Autogenerated by build_tools/bazel_to_cmake/bazel_to_cmake.py from           #
# compiler/src/iree/compiler/Codegen/LLVMCPU/BUILD.bazel                       #
#                                                                              #
# Use iree_cmake_extra_content from iree/build_defs.oss.bzl to add arbitrary   #
# CMake-only content.                                                          #
#                                                                              #
# To disable autogeneration for this file entirely, delete this header.        #
################################################################################

iree_add_all_subdirs()

iree_tablegen_library(
  NAME
    PassesIncGen
  TD_FILE
    "Passes.td"
  OUTS
    --gen-pass-decls Passes.h.inc
)

iree_cc_library(
  NAME
    PassHeaders
  HDRS
    "PassDetail.h"
    "Passes.h"
    "Passes.h.inc"
  DEPS
    ::PassesIncGen
    MLIRLinalgTransforms
    MLIRMemRefDialect
    MLIRPass
    MLIRTransforms
    iree::compiler::Codegen::Dialect::Codegen::IR::IREECodegenDialect
    iree::compiler::Dialect::HAL::IR
    iree::compiler::Utils
  PUBLIC
)

iree_cc_library(
  NAME
    LLVMCPU
  HDRS
    "DispatchABI.h"
    "FuseConvVecFunc.h"
    "FuseConvVecOp.h"
    "KernelDispatch.h"
    "Passes.h"
    "TargetMLTransformInfo.h"
    "Utils.h"
  SRCS
    "CIMWiseKernelDispatch.cpp"
    "CIMWiseTiledConvPass.cpp"
    "ConvertNPUOps.cpp"
    "ConvertToLLVM.cpp"
    "DispatchABI.cpp"
    "FuseConvVecFunc.cpp"
    "FuseConvVecOp.cpp"
    "ExpandF16OpToF32Pass.cpp"
    "KernelDispatch.cpp"
    "LLVMCPUAssignConstantOrdinals.cpp"
    "LLVMCPUAssignImportOrdinals.cpp"
    "LLVMCPUCheckIRBeforeLLVMConversion.cpp"
    "LLVMCPUDropVectorUnitDims.cpp"
    "LLVMCPUEmitVectorizationRemarks.cpp"
    "LLVMCPULinkExecutables.cpp"
    "LLVMCPULowerExecutableTarget.cpp"
    "LLVMCPUMmt4dVectorLowering.cpp"
    "LLVMCPUPeel.cpp"
    "LLVMCPUSelectLoweringStrategy.cpp"
    "LLVMCPUSplitReduction.cpp"
    "LLVMCPUSynchronizeSymbolVisibility.cpp"
    "LLVMCPUTile.cpp"
    "LLVMCPUTileAndFuse.cpp"
    "LLVMCPUUnfuseFMAOps.cpp"
    "LLVMCPUVectorShapeCastLowering.cpp"
    "LLVMCPUVectorTransferLowering.cpp"
    "LLVMCPUVectorTransposeLowering.cpp"
    "LLVMCPUVirtualVectorLowering.cpp"
    "Passes.cpp"
    "TargetMLTransformInfo.cpp"
    "Utils.cpp"
    "VectorContractCustomKernels.cpp"
    "VerifyLinalgTransformLegality.cpp"
  DEPS
    ::PassHeaders
    ::PassesIncGen
    IREELinalgTransformDialect
    IREELinalgTransformDialectPasses
    LLVMBinaryFormat
    LLVMSupport
    LLVMTargetParser
    MLIRAffineDialect
    MLIRAffineToStandard
    MLIRAffineUtils
    MLIRAnalysis
    MLIRArithDialect
    MLIRArithToArmSME
    MLIRArithToLLVM
    MLIRArithTransforms
    MLIRArmNeon2dToIntr
    MLIRArmNeonDialect
    MLIRArmSMEToLLVM
    MLIRArmSMEToLLVMIRTranslation
    MLIRArmSMEToSCF
    MLIRArmSMETransforms
    MLIRBufferizationDialect
    MLIRComplexToLLVM
    MLIRComplexToStandard
    MLIRControlFlowToLLVM
    MLIRFuncDialect
    MLIRFuncToLLVM
    MLIRFuncTransforms
    MLIRFunctionInterfaces
    MLIRIR
    MLIRLLVMCommonConversion
    MLIRLLVMDialect
    MLIRLinalgDialect
    MLIRLinalgTransforms
    MLIRLinalgUtils
    MLIRMathDialect
    MLIRMathToLLVM
    MLIRMathTransforms
    MLIRMemRefDialect
    MLIRMemRefToLLVM
    MLIRMemRefTransforms
    MLIRPDLDialect
    MLIRPDLInterpDialect
    MLIRPass
    MLIRReconcileUnrealizedCasts
    MLIRSCFDialect
    MLIRSCFToControlFlow
    MLIRSCFTransforms
    MLIRSCFUtils
    MLIRTensorDialect
    MLIRTensorTransforms
    MLIRTosaDialect
    MLIRTosaToArith
    MLIRTransformDialect
    MLIRTransforms
    MLIRValueBoundsOpInterface
    MLIRVectorDialect
    MLIRVectorToArmSME
    MLIRVectorToLLVM
    MLIRVectorToSCF
    MLIRVectorTransforms
    MLIRX86VectorTransforms
    iree::compiler::Codegen::Common
    iree::compiler::Codegen::Common::CPU::CommonCPUPasses
    iree::compiler::Codegen::Common::TransformDialectInterpreterPass
    iree::compiler::Codegen::Dialect::Codegen::IR::IREECodegenDialect
    iree::compiler::Codegen::Interfaces::PartitionableLoopsInterface
    iree::compiler::Codegen::TransformStrategies::CPU
    iree::compiler::Codegen::Transforms
    iree::compiler::Codegen::Utils
    iree::compiler::Dialect::Flow::IR
    iree::compiler::Dialect::HAL::IR
    iree::compiler::Dialect::HAL::IR::HALDialect
    iree::compiler::Dialect::LinalgExt::IR
    iree::compiler::Dialect::LinalgExt::Transforms
    iree::compiler::Dialect::LinalgExt::Utils
    iree::compiler::Dialect::Util::IR
    iree::compiler::Dialect::Util::Transforms
    iree::compiler::Utils
    iree::schemas::cpu_data
    iree::schemas::instruments
  PUBLIC
)


### Python ###

# 1) 找 Python（含头文件与库）
find_package(Python3 COMPONENTS Interpreter Development REQUIRED)

# 2) 解析 LLVMCPU 的真实目标名（把别名解引用）
#    ALIASED_TARGET 若存在，则其值就是真实的可操作 target
get_target_property(_LLVMCPU_REAL iree::compiler::Codegen::LLVMCPU ALIASED_TARGET)
if(_LLVMCPU_REAL)
  set(LLVMCPU_TARGET "${_LLVMCPU_REAL}")
else()
  # 兜底：某些配置下别名属性不存在；尝试常见的真实名
  set(LLVMCPU_TARGET "iree_compiler_Codegen_LLVMCPU")
endif()

# 防御：确保目标存在
if(NOT TARGET ${LLVMCPU_TARGET})
  message(FATAL_ERROR "LLVMCPU target '${LLVMCPU_TARGET}' not found. Run 'cmake --build <build> --target help' or 'ninja -t targets' to inspect the exact name, then replace it here.")
endif()

# 3) 给真实目标链接 Python，并设置 rpath
target_link_libraries(${LLVMCPU_TARGET} PUBLIC Python3::Python)

execute_process(
  COMMAND ${Python3_EXECUTABLE} -c "import sysconfig;print(sysconfig.get_config_var('LIBDIR'))"
  OUTPUT_VARIABLE PY_LIBDIR
  OUTPUT_STRIP_TRAILING_WHITESPACE
)
set_target_properties(${LLVMCPU_TARGET} PROPERTIES
  BUILD_RPATH "${PY_LIBDIR}"
  INSTALL_RPATH "${PY_LIBDIR}"
)

# 4) 构建后把脚本复制到目标文件所在目录下的 py/ 中
add_custom_command(TARGET ${LLVMCPU_TARGET} POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E make_directory $<TARGET_FILE_DIR:${LLVMCPU_TARGET}>/py
  COMMAND ${CMAKE_COMMAND} -E copy_if_different
          ${CMAKE_CURRENT_SOURCE_DIR}/py
          $<TARGET_FILE_DIR:${LLVMCPU_TARGET}>/py
  COMMENT "Copying Python helper script(s) for LLVMCPU pass"
)

# 5) 在 C++ 里可用的脚本目录宏（你的 pass 里用 sys.path.append 追加它）
target_compile_definitions(${LLVMCPU_TARGET}
  PUBLIC MYPASS_PYDIR="$<TARGET_FILE_DIR:${LLVMCPU_TARGET}>/py"
)
target_compile_definitions(${LLVMCPU_TARGET}
  PRIVATE 
    MYPASS_PYDIR="$<TARGET_FILE_DIR:${LLVMCPU_TARGET}>/py"
    CIMWISE_PYTHON_PATH="${CMAKE_CURRENT_SOURCE_DIR}/py"
)


### BAZEL_TO_CMAKE_PRESERVES_ALL_CONTENT_BELOW_THIS_LINE ###
